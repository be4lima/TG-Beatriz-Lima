# Análise de séries temporais

Qualquer conjunto de observações ordenadas no tempo são chamadas de Séries Temporais. No caso da Engenharia Ambiental e Urbana, podem ser citados alguns exemplos: valores diários de poluição, valores mensais de temperatura, temperaturas máximas e mínimas diárias ou precipitação atmosférica anual em uma cidade, entre outros (Morettin, 2018). 

É suposto que, em uma análise de série temporal, "*há um sistema causal mais ou menos constante, relacionado com o tempo, que exerceu influência sobre os dados no passado e pode continuar a fazê-lo no futuro. Este sistema causal costuma atuar criando padrões não aleatórios que podem ser detectados em um gráfico da série temporal, ou mediante algum outro processo estatístico*" (REIS, 2022).

É importante citar que identificar esses padrões não aleatórios na série temporal de uma variável de interesse é o objetivo da análise. A partir dessa identificação, é possível realizar previsões, orientando tomadas de decisões na área de interesse (REIS, 2022).

A partir de procedimentos estatísticos, é possível realizar a análise da série de dados de forma que seja possível realizar previsões, analisar causalidades e estudar periodicidades relevantes. Conforme COSTA (2022) e SOARES (2020), em resumo, nas séries temporais caracterizam-se por:

  1. Possuirem variáveis aleatórias;
  2. Observações altamente correlacionadas, principalmente porque medidas adjacentes (próximas no tempo) tendem a correlatas;
  3. Existência de fatores determinísticos, como tendência, sazonalidade e ciclos;
  4. Dificuldade em lidar com outliers;
  5. Mudanças fundamentais/abruptas.

De acordo com Reis (2022) e Barros et. al (2022), séries temporais são compostas pelos seguintes padrões:

1) **Tendência (T)**: série temporal que segue determinada direção, não necessariamente linear, podendo também ser crescente ou decrescente. Exemplos podem ser: crescimento demográfico, ou mudança gradual de hábitos de consumo, ou qualquer outro aspecto que afete a variável de interesse no longo prazo;

2) **Variações cíclicas ou ciclos (C)**, flutuações nos valores da variável com duração superior a um ano, e que se repetem com certa periodicidade, que podem ser resultado de variações da economia como períodos de crescimento ou recessão, ou fenômenos climáticos como o El Niño (que se repete com periodicidade superior a um ano);

3) **Variações sazonais ou sazonalidade (S)**, flutuações nos valores da variável com duração inferior a um ano, e que se repetem todos os anos, geralmente em função das estações do ano (ou em função de feriados ou festas populares, ou por exigências legais, como o período para entrega da declaração de Imposto de Renda); se os dados forem registrados anualmente NÃO haverá influência da sazonalidade na série;

4) **Variações irregulares (I)**, que são as flutuações inexplicáveis, resultado de fatos inesperados como catástrofes naturais, decisões intempestivas de governos, etc.

Estes são estudados para controlar o efeito de cada componente a fim de analisar o comportamento de cada "série filtrada" e, ainda, analisar as particularidades de cada componente (COSTA, 2022).

```{r figura 3.1, fig.cap="Figura 3.1: Séries exibindo diferentes tipos de padrões (Fonte: BARROS et. al, 2022)"} 


knitr::include_graphics("Figuras/Fig4_1.jpg")

```
De acordo com COSTA (2022), existem duas abordagens na análise de séries temporais:

  1. **Clássica**: descreve o comportamento da série por meio de componentes não observáveis, ou seja, a tendência, sazonalidade e ciclo. Os desvios em torno dos valores determinísticos^[Em um modelo determinístico, indepentemente dos conjuntos de entrada, o resultado será sempre o mesmo conjunto de saídas.] ocorrem por erros aleatórios e não pela natureza estocástica da série.
  
  
  2. **Moderna**: supões que a série temporal seja formada por um processo estocástico^[Processo estocástico: sequência de variáveis aleatórias cujas características probabilísticas não se alteram ao longo do tempo. Exemplo: No lançamento de dados cada face tem a mesma probabilidade de ficar para cima]. Sendo cada observação composta por um conjunto de variáveis aleatórias, estas são representadas por funções de densidade individuais. Para capturar sua característica estocástica, são utilizadas modelos estatísticos.

## Estacionaridade
Para realizar a abordagem de séries temporais assume-se que esta seja formada por um processo estocástico, como citado anteriormente. De forma resumida, uma série estacionária possui a mesma distribuição de probabilidade para cada observação.

A estacionaridade divide-se em: forte, em que a função densidade de probabilidade não varia no tempo e as distribuição são iguais para todo $t$; fraca, em que a média, variância e covariância permanecem constantes ao longo do tempo. A estacionaridade fraca é menos restritiva que a forte e, por isso, será a abordagem escolhida.

Uma série fracamente estacionária tem as seguintes características:

1. A média é igual a uma constante
2. A variância é constante e finita;
3. A covariância é dependente somente da diferença no tempo (h) entre duas medidas, sendo a covariância:

$$\tag{4.3}Cov(X_t,X_{t+h})=\sum(X_t-\overline{X_t})(X_{t+h}-\overline{X_{t+h}})$$, em que $X_t$ é a própria série temporal e $h$ é o intervalo de tempo entre as duas medidas.

Dessa forma, quando a covariância é positiva, a tendência é positiva entre $X_t$ e $X_{t+h}$. Quando a covariância é negativa, a tendência também é negativa. Se a covariância for nula, não existe tendência.

É importante citar que se uma série não for estacionária, modelos padrões podem não representar de forma adequada o processo gerador da série temporal e, por isso, não seria possível utilizar o modelo para realizar previsões ou outros objetivos da análise. Conforme o Teorema de Wald, a estacionariedade dá estabilidade e coerência ao modelo.

## Operador de diferenças

### Testes de raiz unitária

##Ruído branco
No ruído branco, toda a trajetória da série temporal é atribuida a fatores puramente aleatórios. Ou seja, variáveis aleatórias não correlacionadas em um processo estocástico ${\epsilon_t, t \in T}$  possuem média zero e variância constante, portanto, $\epsilon_t\sim RB(0,\sigma^2)$.

É representado como:
$$\tag{4.5}y_t=\epsilon_t$$

## Passeio aleatório
O passeio aleatório é representado por $\tag{4.6}y_t=y_{t-1}+\epsilon_t$ em que $\epsilon_t\sim RB(0,\sigma^2)$. Portanto, o valor da série em $t$ é igual ao valor da série em um instante anterior somado a um erro de média zero e variância constante.

É possível escrever o passeio aleatório em função de $y_0$:
$$y_t=y_0+\sum_{i=1}^t{\epsilon_i}$$

## Modelos ARIMA
Um modelo ARIMA (Modelos autoregressivos integrados de médias móveis), a partir da abordagem de Box & Jenkins, permite que previsões sejam realizadas tomando por base valores presentes e passados da série temporal. O modelo é formado por três componentes: o Auto Regressivo (AR), o filtro de integração (I) e o componente de médias móveis. 

Um modelo AR(p) é baseado na ideia de que um valor atual $y_t$ pode ser explicado como uma função de valores passados. Este pode ser descrito como:
$$y_t=c+\phi_1y_{t-1}+...+\phi_py_{t-p}+\epsilon_t$$ onde $\phi_p$ são parâmetros auto-regressivos; $c$ é uma constante e $\epsilon_t \sim RB(0,\sigma^2)$

Já um modelo MA(q):
$$y_t=\mu+\epsilon_t-\theta_1\epsilon_{t-1}-...-\theta_q\epsilon_{t-q}$$, onde $\theta_n$ são parâmetros de médias móveis; $c$ é uma constante e $\epsilon_t\sim(0,\sigma^2)$.


## Modelos SARIMA

Quando considerada a sazonalidade, o modelo é denominado SARIMA $(p,d,q)(P,D,Q)_s$, representado pela equação 4.15.
$$\tag{4.15}\phi(L)\Phi(L)\Delta^d\Delta^Dy_t=\theta(L)\Theta(L)\epsilon_t$$, em que:

p: ordem do polinômio autoregressivo não sazonal $\phi(L)$
P: orgem do polinômio autoregressivo sazonal $\Phi(L)$
q: ordem do polinômio de médias móveis não sazonal $\theta(L)$
Q: ordem do polinômio de médias móveis sazonal $\Theta(L)$
d: ordem de diferença não sazonal
D: ordem de diferença sazonal
$\phi(L)=(1-\phi_1L-\phi_2L^2-...-\phi_pL^p$
$\Phi(L)=(1-\Phi_1L^s-\Phi_2L^{2s}-...-\Phi_pL^{Ps})$
$\theta(L)=(1-\theta_1L-\theta_2L^2-...-\theta_pL^q)$
$\Theta(L)=(1-\Theta_1L^2-\Theta_2L^{2s}-\Theta_pL^{Qs})$
$\Delta-=1-L$, sendo o operador de desafasagem (L): $L^ny_t=y_{t-n}$


Conforme Morettin (2018), Na abordagem de Box & Jenkins, existem 4 etapas:
1. Identificação do processo gerador de dados
Para descobrir qual modelo descreve melhor o comportamento dos dados, inicialmente, realiza-se uma análise gráfica, verificando estacionaridade, tendência, sazonalidade, etc. A partir disso, utiliza-se a FAC e FACP (função de autocorrelação parcial) amostrais, além de verificar a ordem de integração da série, ou seja, número de diferenças necessárias para tornar uma série estacionária. 


2. Estimação de parâmetros
Os parâmetros do modelo são identificados e testados estatisticamente e, para isso, utilizam-se critérios de informação.

3. Verificação do modelo (diagnóstico)

  a) resíduos devem possuir média zero, variância constante e serem estacionários, comportando-se como um *ruído branco*.
  b) As funções de autocorrelação devem ser não significativas, ou seja, devem ficar dentro do intervalo de confiança.
  c) Pelo teste de Ljung-Box,avalia-se se o modelo sugerido é adequado.
  d) Verifica-e se os critérios AIC e BIC possuem valores menores.
  
  Caso haja qualquer problema na etapa, volta-se à etapa de Identificação.
  
4. Previsão

## Aplicação {-}
Para a aplicação, será realizado o exemplo do capítulo 4 do livro de BARROS *et.al* (2017). Será utilizada como *database* a série temporal de vendas de passagens aéreas nos EUA de janeiro de 1949 a dezembro de 1960. 

```{r}
# Intalando pacotes necessários
  install.packages("BETS")
  install.packages("urca")
  install.packages("TSA")
  install.packages("forecast")
  install.packages("lmtest")
  install.packages("normtest")
  install.packages("FinTS")
  install.packages("xlsx")
```

```{r}
# Carregando a série temporal
  data(AirPassengers)

# Análise gráfica
  ts.plot(AirPassengers, ylab = "Vendas de Passagens ", xlab = "Anos")

```
A partir do gráfico é possível perceber que existe uma tendência de aumento nas vendas de passagens. Em relação à variância, verifica-se que a distância entre os meses de maior e menor venda está aumentando, indicando uma variância não constante. Além de haver oscilações que se repetem anualmente, dando indícios de presença de sazonalidade, que será analisada mensalmente abaixo:

```{r}
monthplot(AirPassengers,ylab = "Vendas de Passagens ", xlab = "Meses")
```

No gráfico acima, os traços horizontais representam a média, a qual aumenta nos meses de férias dos EUA (Junho, Julho e Agosto). Pelos traços verticais e sua inclinação positiva, é possível verificar um aumento constante na venda de passagens ao longo dos anos. Ambos trazem indícios da não estacionariedade da série temporal.

Conforma comentado ao longo do capítulo, a série temporal é composta por quatro componentes não observáveis e estas serão analisadas a seguir com a função `decompose()`.
```{r}

plot(decompose(AirPassengers))
```
A partir da figura acima, verifica-se que a série temporal é fortemente afetada pela tendência (*trend*), além da sazonalidade (*seasonal*). Sobra, ainda, a componente aleatória que é levemente "contmainada" pela componente sazonal, como é possível verificar na comparação entre *random* e *seasonal* no gráfico.

Conforme citado anteriormente, as análises gráficas dão indícios de não estacionariedade. Portanto, a estacionariedade será testada com significância estatística na parte não sazonal e sazonal da série temporal. Para isso, será realizada novamente a análise gráfica, além da comparação da média e da variância em diferentes períodos, observação da Função de Autocorrelação (FAC) e testes de raiz unitária. 

  - **Parte não sazonal**
  A identificação da autocorrelação entre o valor atual e suas defasagens (lags) é feita abaixo. O intervalo de confiança (de 95%) são as linhas pontilhadas vermelhas e valores acima ou abaixo da linha são estatisticamente significantes. Portanto, existe autocorrelação significante até a defasagem 36.
  
```{r}
  require(BETS)
    BETS::corrgram(AirPassengers, lag.max = 36, ci=0.95)
```
  
  No teste ADF, existem três formas de realizar o teste de Raiz Unitária (RU): raiz unitária + constante + tendência determinística escolhe-se 'type="trend"'; raiz unitária + constante, `type = "dryft"`; raiz unitária, `type= "none"`. No teste de raiz unitária, a hipótese nula é que a série temporal possui uma raiz unitária (ST é não estacionária) e a hipótese alternativa é que a série é estacionária.
  
  Considerando a série temporal como sem tendência, com variância constante e com o critério de informação sendo o AIC:
  
```{r}
  adf.drift <- urca::ur.df(y=AirPassengers, type= "drift", lag=24, selectlags="AIC")
  BETS::corrgram(adf.drift@res, lag.max=36)
 
  # Estatística de teste 
  adf.drift@teststat 
  adf.drift@cval #valores tabulados por MacKinnon (1996)
```
A partir do gráfico, é possível afirmar que não há presença de autocorrelação nos resíduos. Além disso, a estatística teste ($\tau^2=1,8582$) é maior do que o valor máximo associado ao nível de confiança (-2,88). Portanto, a hipótese nula não é rejeitada e é possível concluir que a série temporal não é estacionária e possui raiz unitária. Agora precisamos descobrir o número de diferenciações necessárias para torná-la estacionária. 
 
```{r}
  ts.plot(diff(AirPassengers, lag=1, differences=1))
  BETS::corrgram(diff(AirPassengers, lag=1, differences=1))
```
 Com uma diferenciação é possível verificar que a série está estacionária na média, mas não na variância, porque esta está crescendo ao longo do tempo. Portanto, será aplicado *log* na série temporal para que a variância passe a ser contante:
```{r}
  ts.plot(diff(log(AirPassengers), lag=1, differences=1))
  BETS::corrgram(diff(log(AirPassengers), lag=1, differences=1))
```
 
  - **Parte sazonal**
Pelo gráfico de correlação, é possível verificar que nos lags sazonais (12, 24, 36...) a função de autocorrelação apresenta um decrescimento, o que indica que a série temporal não é estacionária. 

```{r}
BETS::corrgram(diff(diff(log(AirPassengers), lag = 1, differences = 1), lag = 12, differences = 1), lag.max = 48)

```
A partir da figura acima, é possível verificar que a FAC não apresenta mais o decrescimento de antes, além de ter cortes bruscos nos lags 1 e 12. Para verificar a estacionariedade, será realizado o teste de RU:

```{r}
  adf.drift2 <- urca::ur.df(y = diff(diff(log(AirPassengers), lag = 1), lag = 12), type = "drift", lags = 24, selectlags = "AIC")

  adf.drift2@teststat # Estatística de Teste
  
  adf.drift2@cval #valores tabulados por MacKinnon (1996)
  
  BETS::corrgram(adf.drift2@res, lag.max = 36)
  
```
A estatística teste ($\tau^2=-4.03891$) é menor do que o valor máximo associado ao nível de confiança (-2,88). Portanto, conclui-se que a série é estacionária.

A partir daqui, será aplicado o método de Box & Jenkins. Para a fase de **identificação** será observado a FAC e FACP do modelo estacionário:
````{r}
#FAC
  BETS::corrgram(diff(diff(log(AirPassengers), lag = 1, differences = 1), lag = 12, differences = 1), lag.max = 48)

#FACP
  BETS::corrgram(diff(diff(log(AirPassengers), lag = 1, differences = 1), lag = 12, differences = 1), type = "partial", lag.max = 48)
````

## Referências Bibliográficas {-}

BARROS, Anna C.; MATTOS, Daiane Marcolino D.; OLIVEIRA, Ingrid Christyne Luquett D.; et al. **Análise de Séries Temporais em R: Curso Introdutório**. Grupo GEN, 2017. 9788595154902. Disponível em: https://integrada.minhabiblioteca.com.br/#/books/9788595154902/. Acesso em: 21 jun. 2022.

MORETTIN, Pedro A. Análise de Séries Temporais. Editora Blucher, 2018. 9788521213529. Disponível em: https://integrada.minhabiblioteca.com.br/#/books/9788521213529/. Acesso em: 10 jun. 2022.

REIS, Marcelo Menezes. Análise de séries temporais. Santa Catarina, UFSC, 2022. Disponível em: <https://www.inf.ufsc.br/~marcelo.menezes.reis/Cap4.pdf> Acesso em: 10 jun. 2022.

SOARES, Thiago Costa. Séries Temporais. Universidade Federal de Juiz de Fora, 2020. Disponível em: <https://www.youtube.com/watch?v=T4N8ZhmiUEM&list=PLW1zGvUGqyiEw1O3HAcjezB9esyI8R8xe&index=5>. Acesso em: 29 jun 2022.

COSTA, Alexandre Cunha. "Introdução à Análise de Séries Temporais". Disponível em: <https://www.youtube.com/watch?v=emnSZ7qKv9M&list=PLSDVadsSlXTCVcg95hQsEOVRnVwgaPTRC&index=1> Acesso em: 27 jun. 2022.

https://www.maxwell.vrac.puc-rio.br/24787/24787_3.PDF